<!DOCTYPE HTML>
<html>
<head>
<title>Cordova</title>
<script src="phonegap.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8" src="assets/js/cordova-1.9.0.js"></script>
<script type="text/javascript" charset="utf-8" src="assets/js/zepto.min.js"></script>
<script type="text/javascript" charset="utf-8" src="assets/js/underscore-min.js"></script>
<script type="text/javascript" charset="utf-8" src="assets/js/distance.js"></script>

<script type="text/javascript">
	$(function () {
		$('button').click(function () {
			//get location
			navigator.geolocation.getCurrentPosition(crosscom.updateLocation);

			//get closest bus stop
			var stop = crosscom.getClosestStop();
			$('#stopname').html(crosscom.stop.name);

			//get timetable
			$.ajax({ 
						url: 'http://lprwilima.lappeenranta.fi:8080/karttasovellus/MainServlet',

						type:'POST',

						data:{
								StopId:crosscom.stop.id,
								lang:'fi_FI',
								_:''
							}, 

						// dataType: 'json',

						success: function (response, status, xhr){
							var buses = JSON.parse(response);
							var res = '';

							for(var i = 0; i < buses.length; i++) 
								res += buses[i].time + '<br/>';
							$('#timetable').html(res);					
						},
						 
						 error: function(xhr, type){
						    $('#timetable').html('ERROR');	
						  }
					});

			//display timetable
		});
	});

	var crosscom = {
		updateLocation:function (pos) {
			crosscom.position = {
				lat:pos.coords.latitude,
				lon:pos.coords.longitude,
				acc:pos.coords.accuracy,
				ts:pos.timestamp
			};
		},

		getClosestStop:function () {
			var stop = _.sortBy(crosscom.stops,function (another_stop){
				return distance(
						crosscom.position.lat,
						another_stop.lat,
						crosscom.position.lon,
						another_stop.lon,
						true);				
			})[0];

			crosscom.stop = {
				name:stop.name,
				id: stop.id
			}
		},

		onError:function () {alert('onError!');},

		position : {lat:61.064474,lon:28.092513,acc:1}
	};	
</script>
<style type="text/css">
button {
	width:100%;
	font-size: 2em;
}
h4 {
	margin-bottom: .1em;
}
p {
	margin-top: .1em;
}
</style>
<script type="text/javascript" charset="utf-8" src="lappe-stops.js"></script>
</head>
<body>
	<button>Update timetable</button>
	<h4>Closest busstop</h4>
	<p id="stopname"></p>
	<h4>Busses</h4>
	<p id="timetable"></p>
</body>
</html>
